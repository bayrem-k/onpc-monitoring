
# Global tags
telegraf_global_tags:
  - tag_name: node_type
    tag_value: "{{ 'container' if inventory_hostname in groups['all_containers'] else 'host' }}"
  - tag_name: region
    tag_value: "{{ service_region }}" 

# agent variables
telegraf_agent_version: latest
telegraf_agent_metric_batch_size: 1024
telegraf_agent_metric_buffer_limit: 10240
telegraf_agent_quiet: True
telegraf_agent_hostname: "{{ ansible_hostname if inventory_hostname in groups['all_containers'] else inventory_hostname }}"

# Outputs
influxdb_telegraf_targets: "{{ influxdb_protocol|default('http') }}://{{ influxdb_host|default(internal_lb_vip_address) }}:{{ influxdb_port }}"
telegraf_agent_output:
  - type: influxdb
    config:
      - urls: ["{{ influxdb_telegraf_targets | map('quote') | join(',') }}"]
      - database: {{ monitoring_influxdb_name }}
      - precision: "s"
      - write_consistency: "any"
      - timeout: "5s"

# Prometheus Client Outputs Plugin
# outputs_prometheus_client_listen: ":9126"
# outputs_prometheus_client_expiration_interval: "60s"
# - type: prometheus_client
#   config:
#     - listen: "{{ outputs_prometheus_client_listen | default(':9126') }}"
#     - expiration_interval: "{{ outputs_prometheus_client_expiration_interval | default('60s') }}"

{% if inventory_hostname in groups['all_containers'] %}
telegraf_plugins_default:
  - plugin: processes
  - plugin: cpu
    config:
      - percpu = true
  - conntrack:
    config:
      - files: ["ip_conntrack_count","ip_conntrack_max", "nf_conntrack_count","nf_conntrack_max"]
      - dirs: ["/proc/sys/net/ipv4/netfilter","/proc/sys/net/netfilter"]    
  - plugin: disk
  - plugin: io
  - plugin: mem
  - plugin: system
  - plugin: swap
  - plugin: netstat
  - plugin: net
{% else %}

{% endif %}

## HAProxy variables for telegraf
haproxy_stats_enabled: True
haproxy_stats_bind_address: 127.0.0.1
haproxy_stats_port: 1936
haproxy_username: admin
